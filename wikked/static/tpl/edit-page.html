<article class="row">
    <div class="page span12">
        <h1>{{meta.title}} <span class="decorator">Editing</span></h1>
        <form id="page-edit" class="page-edit row">
            <div class="span12">
                <div id="wmd-button-bar"></div>
            </div>
            <div class="span12">
                <div class="wmd-input-wrapper">
                    <textarea id="wmd-input" name="text" placeholder="Your page's contents go here...">{{content}}</textarea>
                    <div class="wmd-input-grip"></div>
                </div>
            </div>
            <div class="span12">
                <div class="wmd-preview-wrapper">
                    <h3><a class="btn"><i class="icon-minus"></i></a> Preview</h3>
                    <div id="wmd-preview" class="wmd-preview"></div>
                </div>
            </div>
            <div class="span12">
                    <div class="controls commit-meta">
                        <div class="control-group input-prepend">
                            <label for="author" class="control-label add-on">Author: </label>
                            <input type="text" name="author" class="" placeholder="{{commit_meta.author}}"></input>
                        </div>
                        <div class="control-group input-prepend">
                            <label for="message" class="control-label add-on">Change Description: </label>
                            <input type="text" name="message" class="input-xxlarge" placeholder="{{commit_meta.desc}}"></input>
                        </div>
                    </div>
            </div>
            <div class="span12">
                <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> Save</button>
                <a href="{{url_read}}" class="btn">Cancel</a>
            </div>
        </form>
    </div>
</article>
<script type="text/javascript" src="/js/pagedown/Markdown.Converter.js"></script>
<script type="text/javascript" src="/js/pagedown/Markdown.Sanitizer.js"></script>
<script type="text/javascript" src="/js/pagedown/Markdown.Editor.js"></script>
<script type="text/javascript">
    (function() {
            var formatter = _.extend(this.Wikked.PageFormatter, {});
            var converter = new Markdown.Converter();
            converter.hooks.chain("preConversion", function(text) {
                return formatter.formatText(text);
            });
            
            //var help = function () { alert("Do you need help?"); }
            //var options = {
            //    helpButton: { handler: help },
            //    strings: { quoteexample: "whatever you're quoting, put it right here" }
            //};
            var editor = new Markdown.Editor(converter); //TODO: pass options
            editor.run();

            var editor_control = $('textarea#wmd-input');
            editor_control.outerWidth($('.wmd-input-wrapper').innerWidth());

            var last_pageY;
            $(".wmd-input-grip")
                .mousedown(function(e) {
                    last_pageY = e.pageY;
                    $('body')
                        .on('mousemove.wikked.editor_resize', function(e) {
                            editor_control.height(editor_control.height() + e.pageY - last_pageY);
                            last_pageY = e.pageY;
                        })
                        .on('mouseup.wikked.editor_resize mouseleave.wikked.editor_resize', function(e) { 
                            $('body').off('.wikked.editor_resize');
                        });
                });
            $('.wmd-preview-wrapper>h3>a').on('click', function(e) {
                $('#wmd-preview').fadeToggle(function() {
                    var icon = $('.wmd-preview-wrapper>h3>a i');
                    if (icon.hasClass('icon-minus')) {
                        icon.removeClass('icon-minus');
                        icon.addClass('icon-plus');
                    } else {
                        icon.removeClass('icon-plus');
                        icon.addClass('icon-minus');
                    }
                });
            });
        })();
</script>
